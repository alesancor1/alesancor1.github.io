{"componentChunkName":"component---node-modules-nehalist-gatsby-theme-nehalem-src-templates-post-tsx","path":"/oas-tools-sla-rate-limit/","result":{"data":{"post":{"id":"45bc4a32-6630-56ac-a9dd-fea24d072fa9","headings":[{"depth":2},{"depth":2},{"depth":3},{"depth":3},{"depth":2},{"depth":3},{"depth":3},{"depth":3}],"frontmatter":{"title":"Rate limiting requests based on SLA with OAS Tools","path":"/oas-tools-sla-rate-limit/","tags":["Guide","Mid-level","NodeJS","Technologies"],"excerpt":"Guide on how to use the SLA RateLimit module from OAS Tools v3 framework to limit or slow down server requests based on SLA4OAI","created":"2022-12-03T10:51:00.000Z","createdPretty":"03 December, 2022","updated":"2022-12-03T00:00:00.000Z","updatedPretty":"03 December, 2022","featuredImage":{"childImageSharp":{"sizes":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABnElEQVQoz5WST08aQRjG+QD209RLj1488A167VW9ePDkyV5ISlqNJD30gHgw0FtTSRoIJWkNGiyIjQjICiTlXw2mtdvubmFnfjK7/C2lSZ/Ju/PMzLvPPPu+65FSoiCkDS5FigEZQEiByhuGkyOnc4bwqIetxPoo9oe/84xafzQqDSKvI+PMiffniTmCQgiH3NRuWAmsslB4QOw2TujFPh/iH7GkQdm44Lew0O07LGGORP+MKcFk6j3L3iVeHuyw9XSTd5/f8J1v1Mwyz5sbHN3FCLb9ZPXjmTJMOveoA4Xs7RkPT734UiGC8QSL1cf42gHsvrOKXqLeq/DVrmPya+aTlamRQzWLwcJXNHiU7PCkCus1G1XZL5Uqu9sBErEkwVd7pI5S5PN50ulTIuEw0eghbw+jmJY1bIqy7Vbd6EnW0j/xnnfJGu7tP3SdsnZFJpvh5OQY7Vqj1WpxWShwnstRKhXRNI1urzd06LqzB/MnXRDuCOcC+x/d/BucGo675LpsdiFnuFztqTNVo8mYtzf6D93FWHSS/6dJ7gF5Yu4r7M4zRwAAAABJRU5ErkJggg==","aspectRatio":2,"src":"/static/bc57b6b7c96838050f7ff57731dd832a/90823/cover.png","srcSet":"/static/bc57b6b7c96838050f7ff57731dd832a/dc47e/cover.png 200w,\n/static/bc57b6b7c96838050f7ff57731dd832a/9f2d5/cover.png 400w,\n/static/bc57b6b7c96838050f7ff57731dd832a/90823/cover.png 800w,\n/static/bc57b6b7c96838050f7ff57731dd832a/77647/cover.png 1200w,\n/static/bc57b6b7c96838050f7ff57731dd832a/d9a05/cover.png 1395w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"html":"<h2 id=\"sla-rate-limit\" style=\"position:relative;\"><a href=\"#sla-rate-limit\" aria-label=\"sla rate limit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SLA Rate Limit</h2>\n<p>SLA Rate Limit is an npm package containing a rate limitter middleware that can be integrated inside <a href=\"https://github.com/oas-tools/oas-tools\">OAS Tools Core Library</a> in order to limit or input some delay to server requests based on the <a href=\"https://sla4oai.specs.governify.io/\">SLA4OAI</a> Standard. Since this module uses Authorization to determine which requests should limit, the <a href=\"https://oas-tools.github.io/docs/features/security\">Security middleware</a> from OAS Tools'core must be enabled.</p>\n<h2 id=\"setup\" style=\"position:relative;\"><a href=\"#setup\" aria-label=\"setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Setup</h2>\n<h3 id=\"installation\" style=\"position:relative;\"><a href=\"#installation\" aria-label=\"installation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Installation</h3>\n<p>In order to start using SLA Rate Limit just install it through your preferred package manager, in case of NPM:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">npm install @oas-tools/sla-rate-limit</code></pre></div>\n<p>Once installed, import SLARateLimit middleware and call OAS Tools' <code class=\"language-text\">use()</code> function before initialization:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> http <span class=\"token keyword\">from</span> <span class=\"token string\">\"http\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> express <span class=\"token keyword\">from</span> <span class=\"token string\">\"express\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> use<span class=\"token punctuation\">,</span> initialize <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@oas-tools/core\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> SLARateLimit <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@oas-tools/sla-rate-limit\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">use</span><span class=\"token punctuation\">(</span>SLARateLimit<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* Config object */</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>serverPort<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* callback */</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<blockquote>\n<p>Notice the third parameter used in the <code class=\"language-text\">use</code> function. Since the rate limitting action should be performed before processing any request, but after validating any security token, the SLA Rate Limit middleware is inserted in the position <code class=\"language-text\">2</code> of the express chain.</p>\n</blockquote>\n<h3 id=\"configuration\" style=\"position:relative;\"><a href=\"#configuration\" aria-label=\"configuration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Configuration</h3>\n<p>The configuration is set through the second parameter of the <code class=\"language-text\">use</code> function. The table below describes the possible configuration options currently supported by the middleware:</p>\n<table>\n<thead>\n<tr>\n<th><strong>Param</strong></th>\n<th align=\"center\"><strong>Type</strong></th>\n<th><strong>Description</strong></th>\n<th><strong>Default</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>slaFile</td>\n<td align=\"center\">String</td>\n<td>absolute or relative URI to the SLA file</td>\n<td>api/oas-sla.yaml</td>\n</tr>\n<tr>\n<td>requestIdentifier</td>\n<td align=\"center\">String</td>\n<td>Name used in the SLA to identify the requests metric</td>\n<td>requests</td>\n</tr>\n<tr>\n<td>scheme</td>\n<td align=\"center\">String</td>\n<td>Security scheme containing the token with the plan the user is suscribed to</td>\n<td>apikey</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"sla-document\" style=\"position:relative;\"><a href=\"#sla-document\" aria-label=\"sla document permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SLA document</h2>\n<p>This rate limit middleware requires a service level agreement file, in which the declaration for rates and quotas are found. This file should be located by default at <code class=\"language-text\">api/oas-sla.yaml</code>, but this option can be overriden through configuration, as explained above.</p>\n<p>The SLA document must follow the <a href=\"https://sla4oai.specs.governify.io/\">SLA4OAI</a> specification in order to declare dynamic and static windows for requests in a standard way. The example below defines a dynamic window of 1 request per second and a static window of 3 requests per minute for different endpoints:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">sla</span><span class=\"token punctuation\">:</span> 1.0.0\n<span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> rate<span class=\"token punctuation\">-</span>limit<span class=\"token punctuation\">-</span>sample\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> plans\n  <span class=\"token key atrule\">api</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">$ref</span><span class=\"token punctuation\">:</span> ./oas<span class=\"token punctuation\">-</span>doc.yaml\n  <span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span> ISAGroup\n<span class=\"token key atrule\">metrics</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"int64\"</span>\n  <span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Number of requests\"</span>\n<span class=\"token key atrule\">plans</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">base</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">rates</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">/api/v1/resources/1</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">get</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">max</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n            <span class=\"token key atrule\">period</span><span class=\"token punctuation\">:</span> second\n    <span class=\"token key atrule\">quotas</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">/api/v1/resources</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">get</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">max</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n            <span class=\"token key atrule\">period</span><span class=\"token punctuation\">:</span> minute</code></pre></div>\n<p>This way, when making multiple requests to <code class=\"language-text\">/api/v1/resources/1</code>, the requests will be delayed in order to meet the rate criteria, whereas when making more requests than specified in the quotas object, the server response code will be <code class=\"language-text\">429</code> since the quota limit has been exceeded.</p>\n<h3 id=\"plans\" style=\"position:relative;\"><a href=\"#plans\" aria-label=\"plans permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Plans</h3>\n<p>As shown in the example in the previous section, the SLA document must contain <code class=\"language-text\">plans</code> in which the rates and quotas are defined. The SLA Rate Limit middleware receives a token that must contain a <strong>plan</strong> attribute (by default is <code class=\"language-text\">base</code>, as explained in <a href=\"#configuration\">configuration section</a>). This way, multiple plans containing different rates can be declared, making the server <em>suscribe</em> to one or another based on configuration (restaring the server is required when changing a plan).</p>\n<h3 id=\"rates\" style=\"position:relative;\"><a href=\"#rates\" aria-label=\"rates permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rates</h3>\n<p>Rates are managed by the <a href=\"https://www.npmjs.com/package/express-slow-down\">express-slow-down</a> middleware. This middleware will input delay on the requests in order to meet the dynamic window specified under the rates object in the SLA Document.\nRates can be defined along quotas for the same endpoints. This situation is handled by the SLA Rate Limit middleware through chaining <a href=\"https://www.npmjs.com/package/express-slow-down\">express-slow-down</a> and <a href=\"https://www.npmjs.com/package/express-rate-limit\">express-rate-limit</a> middlewares before registering them for the corresponding endpoint inside the express chain.</p>\n<h3 id=\"quotas\" style=\"position:relative;\"><a href=\"#quotas\" aria-label=\"quotas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Quotas</h3>\n<p>Quotas, on the other hand, are managed by the <a href=\"https://www.npmjs.com/package/express-rate-limit\">express-rate-limit</a> middleware. This middleware will make the server respond a <code class=\"language-text\">429 Too Many Requests</code> when the quota is surprassed within the specified static window.</p>"},"primaryTag":{"name":"Guide","color":"#007acc"}},"pageContext":{"postId":"45bc4a32-6630-56ac-a9dd-fea24d072fa9","primaryTag":"Guide"}},"staticQueryHashes":["1116962356","2275848304","545095672","625280739"]}