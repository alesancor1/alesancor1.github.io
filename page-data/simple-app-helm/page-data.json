{"componentChunkName":"component---node-modules-nehalist-gatsby-theme-nehalem-src-templates-post-tsx","path":"/simple-app-helm/","result":{"data":{"post":{"id":"d9173b9f-6d39-5548-ad78-aa36c7b3d5b0","headings":[{"depth":2},{"depth":2},{"depth":2},{"depth":3},{"depth":3},{"depth":2},{"depth":2},{"depth":3},{"depth":3},{"depth":3},{"depth":2}],"frontmatter":{"title":"Creating a Helm Chart for a simple NodeJS App","path":"/simple-app-helm/","tags":["Guide","Mid-level","Helm","Kubernetes"],"excerpt":"Steps on how to create a chart for a simple NodeJS app, connected to a MongoDB host and exposing its endpoints through a Kubernetes service templated with Helm.","created":"2022-02-13T04:12:00.000Z","createdPretty":"13 February, 2022","updated":"2022-02-13T00:00:00.000Z","updatedPretty":"13 February, 2022","featuredImage":{"childImageSharp":{"sizes":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABlElEQVQoz3WQyy8DURjF5w9DJJ7Fwh9g1RLv58aCeG2olYpqF8pCGyFELYimM+2QoNWUamhFUE0XTVsSQVvRO3PMvc1MtPiSM/fmm98597uX6/U2oFw9nnq2dnvqoHdXYMqnx9rNHNr5KnQKNRqjcj/F/RVI1eWpxWyghwUdPm3Al3Rj824JS1djGBRb2GF/+UoC+7yNinToF5uYYeS4FWLCCcftAoyBPjjvbbCEJ2BwV2JAbGYs9ZQEFps6Zfw6dPDVDKbXpPvx0zbw8W0EU0fwJnYRSAswXY5qT0FZylGvmsOpP+g1ppW3MitXct6v4PrFjyx5h1qFrwJCFyFIIHh8jeAgZoc1PIkZv4F5aQ4Vtx9bRzhzhuRHHJ8krwUoTphNFth2rFgNLsJsWcbw0DCM80akk88a9kU+mTeUOcHewxo4lJUkE+UrI5vPIhqJInB9jq1LOxy7Dgi8AJfbhVw+pxAyiETK7eBoQFESZFlmTXVVK/OWwW0qUtL7yVKvmvNrwhJQkpjoJAVSgCwVe/8dTOsbjTs6LkHSdvUAAAAASUVORK5CYII=","aspectRatio":2.127659574468085,"src":"/static/5cd3d231d17fc34575c02983e9d884ae/90823/cover.png","srcSet":"/static/5cd3d231d17fc34575c02983e9d884ae/dc47e/cover.png 200w,\n/static/5cd3d231d17fc34575c02983e9d884ae/9f2d5/cover.png 400w,\n/static/5cd3d231d17fc34575c02983e9d884ae/90823/cover.png 800w,\n/static/5cd3d231d17fc34575c02983e9d884ae/77647/cover.png 1200w,\n/static/5cd3d231d17fc34575c02983e9d884ae/f8d4f/cover.png 1600w,\n/static/5cd3d231d17fc34575c02983e9d884ae/09911/cover.png 2800w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"html":"<style>\n    summary {\n        cursor: pointer;\n    }\n</style>\n<blockquote>\n<p><strong>NOTE</strong>: This guide will assume you have a basic understanding of Helm and Kubernetes and know how to run and manage a cluster. If you haven't already read my post about <a href=\"/helm-fundamentals\">Helm fundamentals</a>, I encourage you to read it first.</p>\n<p>All the code in this guide is available on <a href=\"https://github.com/alesancor1/Blog-Projects/tree/main/guides/simple-app-helm\">GitHub</a></p>\n</blockquote>\n<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>For this guide, we will be deploying the simple NodeJS we build in a previous post, feel free to go <a href=\"/create-simple-app\">check it out</a> first. We will go through all the steps to set up our simple NodeJS app inside a Kubernetes cluster.</p>\n<blockquote>\n<p>This guide is parallel to the <a href=\"/simple-app-kubernetes\">Deploying a simple NodeJS App in kubernetes</a> guide, so you can open both posts and compare them, since both posts will follow the same exact structure.</p>\n</blockquote>\n<p>Unlike kubernetes, before starting to write manifests file like crazy, we first need to create our Helm chart with <code class=\"language-text\">helm create</code> command as explained in the <strong>Helm fundamentals</strong> post. Once created, we can start templating and installing dependencies in our chart.</p>\n<h2 id=\"creating-the-database-manifests\" style=\"position:relative;\"><a href=\"#creating-the-database-manifests\" aria-label=\"creating the database manifests permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creating the Database manifests</h2>\n<p>For the database we will not template the k8s manifests, since there are already created charts in <a href=\"https://artifacthub.io/\">Artifact Hub</a>. We will use the <strong>mongodb chart</strong> from there and configure our <code class=\"language-text\">values.yaml</code> file to adapt it to our needs.</p>\n<p>This way, our <code class=\"language-text\">Chart.yaml</code> file will contain the following under the <code class=\"language-text\">dependencies</code> field:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">...</span>\n<span class=\"token key atrule\">dependencies</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mongodb\n    <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"*\"</span>\n    <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://charts.bitnami.com/bitnami\"</span>\n    <span class=\"token key atrule\">alias</span><span class=\"token punctuation\">:</span> simple<span class=\"token punctuation\">-</span>db</code></pre></div>\n<p>Values will contain the <strong>fields overrides</strong> for the <em>name</em>, <em>namespace</em> and <em>auth</em> values (our app connects to a MongoDB without authentication, so we need to disable it).</p>\n<details>\n<summary> <b>Show values</b> </summary><div style=\"margin-left:20px\">\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># Values.yaml</span>\n<span class=\"token punctuation\">...</span>\n<span class=\"token comment\"># DB Configs</span>\n<span class=\"token key atrule\">simple-db</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">fullnameOverride</span><span class=\"token punctuation\">:</span> simple<span class=\"token punctuation\">-</span>db\n  <span class=\"token key atrule\">nameOverride</span><span class=\"token punctuation\">:</span> simple<span class=\"token punctuation\">-</span>db\n  <span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n<span class=\"token key atrule\">global</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">namespaceOverride</span><span class=\"token punctuation\">:</span> simple<span class=\"token punctuation\">-</span>app</code></pre></div>\n</div></details>\n<blockquote>\n<p>Note we are naming the release <em>simple-db</em> through the <code class=\"language-text\">alias</code> field in dependencies, this let us override the chart values using that key inside <code class=\"language-text\">values.yaml</code>. You can check the docs for the MongoDB chart <a href=\"https://artifacthub.io/packages/helm/bitnami/mongodb\">here</a>.</p>\n</blockquote>\n<h2 id=\"creating-the-app-manifests\" style=\"position:relative;\"><a href=\"#creating-the-app-manifests\" aria-label=\"creating the app manifests permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creating the App manifests</h2>\n<p>Now we have to create our app's <strong>manifest files</strong>, just like we would normally do in kubernetes. However, this time we will use <strong>Helm templates</strong> along the <code class=\"language-text\">values.yaml</code> file to generate them.</p>\n<h3 id=\"service\" style=\"position:relative;\"><a href=\"#service\" aria-label=\"service permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Service</h3>\n<p>Since we want our app to be deployed in both <strong>production</strong> and <strong>development</strong> environments, we usually would need to create to separate manifests for the service. Helm solves that issue thanks to the <strong>templating system</strong>, so we can conditionally add fields to our manifest depending on a value in the <code class=\"language-text\">values.yaml</code> file.</p>\n<p>We will use the <code class=\"language-text\">node_env</code> value to create the manifest for a production or a development environment:</p>\n<details>\n<summary> <b>Show template</b> </summary><div style=\"margin-left:20px\">\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> simple<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">-</span> if eq .Values.node_env \"development\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> NodePort\n  <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">-</span> end <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Values.port <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Values.port <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">-</span> if eq .Values.node_env \"development\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">nodePort</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Values.port <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">-</span> end <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n</div></details>\n<blockquote>\n<p>When templating, you can run the <code class=\"language-text\">helm install</code> command with the <code class=\"language-text\">--dry-run</code> flag to <strong>simulate</strong> the installation and print the resulting manifests that will be applied. Don't forget to run <code class=\"language-text\">helm dep up</code> if your chart has any dependencies</p>\n</blockquote>\n<h3 id=\"deployment\" style=\"position:relative;\"><a href=\"#deployment\" aria-label=\"deployment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deployment</h3>\n<p>Just like we have done for the service, we will now create the deployment template. We will use the <strong>Values</strong> object to get the values and assign them to our container's environment variables so we can make our app as configurable as possible.</p>\n<details>\n<summary> <b>Show template</b> </summary><div style=\"margin-left:20px\">\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> simple<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> PORT\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ .Values.port }}\"</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> DB_HOST\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Values.db_host <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> DB_PORT\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ .Values.db_port }}\"</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> DB_NAME\n            <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Values.db_name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> alesancor1/simple<span class=\"token punctuation\">-</span>app<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.AppVersion <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> Always\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Values.port <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n              <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n          <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 300Mi\n            <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 500Mi</code></pre></div>\n</div></details>\n<p>We are using the <em>port</em>, <em>db_host</em>, <em>db_port</em>, <em>db_name</em> values from the <code class=\"language-text\">values.yaml</code> file to configure our container's environment variables, so we need to provide some default values for them:</p>\n<details>\n<summary> <b>Show values</b> </summary><div style=\"margin-left:20px\">\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># Values.yaml</span>\n\n<span class=\"token comment\"># App Configs</span>\n<span class=\"token key atrule\">node_env</span><span class=\"token punctuation\">:</span> development\n<span class=\"token key atrule\">db_host</span><span class=\"token punctuation\">:</span> simple<span class=\"token punctuation\">-</span>db\n<span class=\"token key atrule\">db_port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">27017</span>\n<span class=\"token key atrule\">db_name</span><span class=\"token punctuation\">:</span> simple<span class=\"token punctuation\">-</span>db\n<span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3300</span>\n<span class=\"token punctuation\">...</span></code></pre></div>\n</div></details>\n<blockquote>\n<p>We are setting those values by <strong>default</strong>, they can be <strong>overriden</strong> when installing the chart through the <code class=\"language-text\">-f &lt;file></code> or the <code class=\"language-text\">--set</code> flags of the <code class=\"language-text\">helm install</code> command.</p>\n</blockquote>\n<h2 id=\"running-locally-on-a-single-node-cluster\" style=\"position:relative;\"><a href=\"#running-locally-on-a-single-node-cluster\" aria-label=\"running locally on a single node cluster permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Running locally on a single node cluster</h2>\n<p>In order to run in a local development environment, we just need to run the <strong>helm install</strong> command. We can override the default values with a new <strong>yaml</strong> file or directly through the <strong>command line</strong>. Since by default it will install for a <strong>development</strong> environment, tthere's no real need to override values, so we can directly run helm install on our chart. Remember to create the namespace before installing it:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$   kubectl create ns simple-app\n$   helm <span class=\"token function\">install</span> simple-app <span class=\"token builtin class-name\">.</span></code></pre></div>\n<p>If you performed all the steps correctly (remember to run only local services manifests), you should be able to see the app running on <a href=\"http://localhost:3300\">http://localhost:3300</a>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a60d624ca06590f5c59d77185c6194c0/f2b95/result.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAt0lEQVQI10WLywqCQBSGfaZaREQKoVBCi3IVtOldAy8zk7pIMrzNnJlGqN6h4yh0+M7t//mt3eniBue1f5w73oRtcLyZ7Y7K/zAsNtuVf1juA4tlOUuzkNBrGIcJiQiLDQlLp8luMR2ICI3poNA0z+9FVjys7wfrDSCeZdnWjeBcCoGvUkpKiQ0Seq1xdW2LVt9rlHnXgBCWUi/81UtVVc07DgLG0BBGb5hS6x6ljnO0tAlLEOj+ALCBqekYjRs7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"result\"\n        title=\"result\"\n        src=\"/static/a60d624ca06590f5c59d77185c6194c0/c1b63/result.png\"\n        srcset=\"/static/a60d624ca06590f5c59d77185c6194c0/5a46d/result.png 300w,\n/static/a60d624ca06590f5c59d77185c6194c0/0a47e/result.png 600w,\n/static/a60d624ca06590f5c59d77185c6194c0/c1b63/result.png 1200w,\n/static/a60d624ca06590f5c59d77185c6194c0/f2b95/result.png 1515w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"production-environments-dns-and-tls-configuration\" style=\"position:relative;\"><a href=\"#production-environments-dns-and-tls-configuration\" aria-label=\"production environments dns and tls configuration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Production environments: DNS and TLS configuration</h2>\n<p>For production environments, we will configure a <strong>DNS record</strong> pointing to the service. We will also configure a TLS certificate and a certificate signing request. For doing that, we will use <strong>Project Contour</strong> and <strong>Cert-Manager</strong> APIs, which simplifies the process. Since they are not native, first thing we need to do is installing them by running:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$    kubectl apply -f https://projectcontour.io/quickstart/contour.yaml\n$    kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.1.0/cert-manager.yaml</code></pre></div>\n<blockquote>\n<p><strong>Project Contour</strong> provide a Load Balancer service that will be our reverse proxy. Be sure to obtain its <strong>external IP</strong> and configure an <strong>A record</strong> in your <strong>NS zone</strong> pointing to that IP. The External IP can be obtained running <code class=\"language-text\">kubectl get -n projectcontour service envoy</code> (it takes a while to be ready).</p>\n<p>Be sure to set the <code class=\"language-text\">node_env</code> value to <code class=\"language-text\">production</code> when installing the chart.</p>\n</blockquote>\n<h3 id=\"issuer-and-clusterissuer\" style=\"position:relative;\"><a href=\"#issuer-and-clusterissuer\" aria-label=\"issuer and clusterissuer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Issuer and ClusterIssuer</h3>\n<p>Before validating TLS certificates, we need to create an Issuer resource that will perform that task and generate the secrets for the certificates. We can create an <strong>Issuer</strong> or a <strong>ClusterIssuer</strong> resource just like we would in Kubernetes. This resource is pretty much the same for kubernetes and Helm, so we will just use the Chart Name for templating.</p>\n<details>\n<summary> <b>Show Template</b> </summary><div style=\"margin-left:20px\">\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">-</span> if eq .Values.node_env \"production\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> cert<span class=\"token punctuation\">-</span>manager.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Issuer\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>letsencrypt\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> simple<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">acme</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">privateKeySecretRef</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>letsencrypt\n    <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//acme<span class=\"token punctuation\">-</span>v02.api.letsencrypt.org/directory\n    <span class=\"token key atrule\">solvers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http01</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">ingress</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">class</span><span class=\"token punctuation\">:</span> contour\n<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">-</span> end <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n</div></details>\n<blockquote>\n<p>This issuer is the same we are using in the <strong>Kubernetes post</strong>, note that we have added the conditional clause wrapping the whole template. Thus, when the condition isn't met <strong>the manifest is blank and Helm will ignore it</strong>.</p>\n</blockquote>\n<h3 id=\"tls-certificates\" style=\"position:relative;\"><a href=\"#tls-certificates\" aria-label=\"tls certificates permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TLS certificates</h3>\n<p>Certificates will be issued by the <strong>Issuer</strong> and stored in a secret consumed by the <strong>HTTPProxy</strong> resource. For this example, we are specifying only one DNS Name, but thanks to Helm we could define an array and dynamically generate the manifest for each one of them.</p>\n<details>\n<summary> <b>Show Template</b> </summary><div style=\"margin-left:20px\">\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">-</span> if eq .Values.node_env \"production\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> cert<span class=\"token punctuation\">-</span>manager.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Certificate\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>certs\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> simple<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">dnsNames</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Values.domain <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">issuerRef</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>letsencrypt\n    <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Issuer\n  <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>certs\n<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">-</span> end <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n</div></details>\n<blockquote>\n<p><strong>NOTE:</strong> Certificates take a while to be issued, it is possible that <strong>HTTPProxy</strong> is created before the certificate is ready. This will cause the <strong>HTTPProxy</strong> service to fail. Check the status of the certs by running <code class=\"language-text\">kubectl describe Certificate &lt;cert-resource-name></code> and restart the HTTPProxy when they are ready.</p>\n</blockquote>\n<h3 id=\"httpproxy\" style=\"position:relative;\"><a href=\"#httpproxy\" aria-label=\"httpproxy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Httpproxy</h3>\n<p>Finally, we will create the <strong>HTTPProxy</strong> resource that will redirect to the corresponding pods depending on the specified <strong>fqdn</strong>. We template it so the <code class=\"language-text\">tls.secretName</code> and the <code class=\"language-text\">services</code> match their corresponding resource names.</p>\n<details>\n<summary> <b>Show Template</b> </summary><div style=\"margin-left:20px\">\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">-</span> if eq .Values.node_env \"production\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> projectcontour.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> HTTPProxy\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>httpproxy\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> simple<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">virtualhost</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">fqdn</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Values.domain <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>certs\n  <span class=\"token key atrule\">routes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Chart.Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Values.port <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">loadBalancerPolicy</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span> Cookie\n<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">-</span> end<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n</div></details>\n<h2 id=\"conclusions\" style=\"position:relative;\"><a href=\"#conclusions\" aria-label=\"conclusions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusions</h2>\n<p>If you have been comparing this post with the <a href=\"/simple-app-kubernetes\">Kubernetes guide</a> you should have noticed that templating the resources is way easier since Helm does a great part of the job for us. Templates and dependencies are one of the biggest strengths of Helm, and makes of it a great tool for deploying complex applications. </p>\n<p>Besides all that have been shown in this guide, charts can be uploaded to the Artifact Hub using GitHub Pages and creating an account (a future post will cover this), and many other features of Helm remain to be discovered. So, if you already knew kubernetes and want to take a step further, Helm is the way to go.</p>"},"primaryTag":{"name":"Guide","color":"#007acc"}},"pageContext":{"postId":"d9173b9f-6d39-5548-ad78-aa36c7b3d5b0","primaryTag":"Guide"}},"staticQueryHashes":["1116962356","2275848304","545095672","625280739"]}